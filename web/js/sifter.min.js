!function(root,factory){"function"==typeof define&&define.amd?define(factory):"object"==typeof exports?module.exports=factory():root.Sifter=factory()}(this,function(){var Sifter=function(items,settings){this.items=items,this.settings=settings||{diacritics:!0}};Sifter.prototype.tokenize=function(query){if(query=trim(String(query||"").toLowerCase()),!query||!query.length)return[];var i,n,regex,letter,tokens=[],words=query.split(/ +/);for(i=0,n=words.length;n>i;i++){if(regex=escape_regex(words[i]),this.settings.diacritics)for(letter in DIACRITICS)DIACRITICS.hasOwnProperty(letter)&&(regex=regex.replace(new RegExp(letter,"g"),DIACRITICS[letter]));tokens.push({string:words[i],regex:new RegExp(regex,"i")})}return tokens},Sifter.prototype.iterator=function(object,callback){var iterator;iterator=is_array(object)?Array.prototype.forEach||function(callback){for(var i=0,n=this.length;n>i;i++)callback(this[i],i,this)}:function(callback){for(var key in this)this.hasOwnProperty(key)&&callback(this[key],key,this)},iterator.apply(object,[callback])},Sifter.prototype.getScoreFunction=function(search,options){var self,fields,tokens,token_count;self=this,search=self.prepareSearch(search,options),tokens=search.tokens,fields=search.options.fields,token_count=tokens.length;var scoreValue=function(value,token){var score,pos;return value?(value=String(value||""),pos=value.search(token.regex),-1===pos?0:(score=token.string.length/value.length,0===pos&&(score+=.5),score)):0},scoreObject=function(){var field_count=fields.length;return field_count?1===field_count?function(token,data){return scoreValue(data[fields[0]],token)}:function(token,data){for(var i=0,sum=0;field_count>i;i++)sum+=scoreValue(data[fields[i]],token);return sum/field_count}:function(){return 0}}();return token_count?1===token_count?function(data){return scoreObject(tokens[0],data)}:"and"===search.options.conjunction?function(data){for(var score,i=0,sum=0;token_count>i;i++){if(score=scoreObject(tokens[i],data),0>=score)return 0;sum+=score}return sum/token_count}:function(data){for(var i=0,sum=0;token_count>i;i++)sum+=scoreObject(tokens[i],data);return sum/token_count}:function(){return 0}},Sifter.prototype.getSortFunction=function(search,options){var i,n,self,field,fields,fields_count,multiplier,multipliers,get_field,implicit_score,sort;if(self=this,search=self.prepareSearch(search,options),sort=!search.query&&options.sort_empty||options.sort,get_field=function(name,result){return"$score"===name?result.score:self.items[result.id][name]},fields=[],sort)for(i=0,n=sort.length;n>i;i++)(search.query||"$score"!==sort[i].field)&&fields.push(sort[i]);if(search.query){for(implicit_score=!0,i=0,n=fields.length;n>i;i++)if("$score"===fields[i].field){implicit_score=!1;break}implicit_score&&fields.unshift({field:"$score",direction:"desc"})}else for(i=0,n=fields.length;n>i;i++)if("$score"===fields[i].field){fields.splice(i,1);break}for(multipliers=[],i=0,n=fields.length;n>i;i++)multipliers.push("desc"===fields[i].direction?-1:1);return fields_count=fields.length,fields_count?1===fields_count?(field=fields[0].field,multiplier=multipliers[0],function(a,b){return multiplier*cmp(get_field(field,a),get_field(field,b))}):function(a,b){var i,result,field;for(i=0;fields_count>i;i++)if(field=fields[i].field,result=multipliers[i]*cmp(get_field(field,a),get_field(field,b)))return result;return 0}:null},Sifter.prototype.prepareSearch=function(query,options){if("object"==typeof query)return query;options=extend({},options);var option_fields=options.fields,option_sort=options.sort,option_sort_empty=options.sort_empty;return option_fields&&!is_array(option_fields)&&(options.fields=[option_fields]),option_sort&&!is_array(option_sort)&&(options.sort=[option_sort]),option_sort_empty&&!is_array(option_sort_empty)&&(options.sort_empty=[option_sort_empty]),{options:options,query:String(query||"").toLowerCase(),tokens:this.tokenize(query),total:0,items:[]}},Sifter.prototype.search=function(query,options){var score,search,fn_sort,fn_score,self=this;return search=this.prepareSearch(query,options),options=search.options,query=search.query,fn_score=options.score||self.getScoreFunction(search),query.length?self.iterator(self.items,function(item,id){score=fn_score(item),(options.filter===!1||score>0)&&search.items.push({score:score,id:id})}):self.iterator(self.items,function(item,id){search.items.push({score:1,id:id})}),fn_sort=self.getSortFunction(search,options),fn_sort&&search.items.sort(fn_sort),search.total=search.items.length,"number"==typeof options.limit&&(search.items=search.items.slice(0,options.limit)),search};var cmp=function(a,b){return"number"==typeof a&&"number"==typeof b?a>b?1:b>a?-1:0:(a=asciifold(String(a||"")),b=asciifold(String(b||"")),a>b?1:b>a?-1:0)},extend=function(a,b){var i,n,k,object;for(i=1,n=arguments.length;n>i;i++)if(object=arguments[i])for(k in object)object.hasOwnProperty(k)&&(a[k]=object[k]);return a},trim=function(str){return(str+"").replace(/^\s+|\s+$|/g,"")},escape_regex=function(str){return(str+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")},is_array=Array.isArray||"undefined"!=typeof $&&$.isArray||function(object){return"[object Array]"===Object.prototype.toString.call(object)},DIACRITICS={a:"[aÀÁÂÃÄÅàáâãäåĀāąĄ]",c:"[cÇçćĆčČ]",d:"[dđĐďĎð]",e:"[eÈÉÊËèéêëěĚĒēęĘ]",i:"[iÌÍÎÏìíîïĪī]",l:"[lłŁ]",n:"[nÑñňŇńŃ]",o:"[oÒÓÔÕÕÖØòóôõöøŌō]",r:"[rřŘ]",s:"[sŠšśŚ]",t:"[tťŤ]",u:"[uÙÚÛÜùúûüůŮŪū]",y:"[yŸÿýÝ]",z:"[zŽžżŻźŹ]"},asciifold=function(){var i,n,k,chunk,foreignletters="",lookup={};for(k in DIACRITICS)if(DIACRITICS.hasOwnProperty(k))for(chunk=DIACRITICS[k].substring(2,DIACRITICS[k].length-1),foreignletters+=chunk,i=0,n=chunk.length;n>i;i++)lookup[chunk.charAt(i)]=k;var regexp=new RegExp("["+foreignletters+"]","g");return function(str){return str.replace(regexp,function(foreignletter){return lookup[foreignletter]}).toLowerCase()}}();return Sifter});